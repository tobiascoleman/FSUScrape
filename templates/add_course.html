{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
            <div class="text-center text-white">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4>Waiting for 2FA Authorization...</h4>
                <p>Please check your phone and approve the login request.</p>
                <p>Time remaining: <span id="countdown">60</span> seconds</p>
            </div>
        </div>
    </div>

    <h2>Add Course</h2>
    <form id="courseForm" method="POST">
        <div class="mb-3">
            <label for="year" class="form-label">Year</label>
            <input type="text" class="form-control" id="year" name="year" required>
        </div>
        <div class="mb-3">
            <label for="term" class="form-label">Term</label>
            <input type="text" class="form-control" id="term" name="term" required>
        </div>
        <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="subject" name="subject" required>
        </div>
        <div class="mb-3">
            <label for="course" class="form-label">Course</label>
            <input type="text" class="form-control" id="course" name="course" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Course</button>
    </form>
</div>

<script>
document.getElementById('courseForm').addEventListener('submit', function(e) {
    document.getElementById('loading-overlay').style.display = 'block';
    startCountdown();
});

// Add message listener for 2FA approval
window.addEventListener('message', function(event) {
    if (event.data === '2fa_approved') {
        document.getElementById('loading-overlay').style.display = 'none';
    }
});

function startCountdown() {
    let timeLeft = 60;
    const countdownElement = document.getElementById('countdown');
    let timer = setInterval(function() {
        timeLeft--;
        countdownElement.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            document.getElementById('loading-overlay').style.display = 'none';
            alert('2FA timeout. Please try again.');
            window.location.reload();
        }
    }, 1000);
    
    // Store timer in window object so it can be cleared if 2FA is approved
    window.countdownTimer = timer;
}
</script>
{% endblock %}
